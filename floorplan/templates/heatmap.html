{% set active_page = "heatmap" -%}
{% extends "templates/base.html" %}

{% block css %}
<!-- bootstrap slider -->
<link href="/floorplan/static/css/bootstrap-slider/slider.css" rel="stylesheet" type="text/css" />
<!-- Theme style -->
<!--link rel="stylesheet" type="text/css" href="static/css/dashboard.css" />
<link rel="stylesheet" type="text/css" href="static/css/rickshaw.css" /-->
<link rel="stylesheet" type="text/css" href="/floorplan/static/css/heatmap.css" />
{% endblock %}

{% block content %}

<!-- Content Header (Page header) -->
<section class="content-header">
  <h1>
    Heatmap
    <small>Live tracking of customers</small>
  </h1>
  <ol class="breadcrumb">
    <li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
    <li class="active">Heatmap</li>
  </ol>
</section>

<!-- Main content -->
<section class="content">
  <!-- Some statistics -->
  <div class="row">
    <div class="col-xs-12">
        <!-- Always set range to max range. Initialization depends on this. -->
        <input type="text" value="" class="slider form-control" data-slider-min="0" data-slider-max="500" data-slider-step="5" data-slider-value="[0,500]" data-slider-orientation="horizontal" data-slider-selection="before" data-slider-tooltip="show" data-slider-id="blue" style="">
    </div>
  </div>
  <div class="row">
    <div class="col-xs-12">
      <canvas id="heatmap-area" width="540" height="540"></canvas>
      {% autoescape False %} 
      {{ svgData }}
      {% endautoescape %}
    </div>
  </div><!-- /.row -->
</section><!-- /.content -->
{% endblock %}
{% block scripts %}
<!-- Bootstrap slider -->
<script src="/floorplan/static/js/plugins/bootstrap-slider/bootstrap-slider.js" type="text/javascript"></script>
<!-- Heatmap WebGL -->
<script type="text/javascript" src="/floorplan/static/js/webgl-heatmap.js"></script>
<script type="text/javascript">
  window.onload = function(){
    var data = [
     {x: 470, y: 306, time: 'January 2, 2014 12:00'},
      {x: 445, y: 309, time: 'January 3, 2014 12:00'},
      {x: 415, y: 315, time: 'January 4, 2014 12:00'},
      {x: 245, y: 332, time: 'January 5, 2014 12:00'},
      {x: 126, y: 347, time: 'January 6, 2014 12:00'},
      {x: 72, y: 352,time: 'January 7, 2014 12:00'},
      {x: 49, y: 353,time: 'January 8, 2014 12:00'},
      {x: 38, y: 348,time: 'January 9, 2014 12:00'},
      {x: 38, y: 347,time: 'January 10, 2014 12:00'},
      {x: 38, y: 312,time: 'January 11, 2014 12:00'},
      {x: 38, y: 302,time: 'January 12, 2014 12:00'},
      {x: 38, y: 297,time: 'January 13, 2014 12:00'},
      {x: 38, y: 277,time: 'January 14, 2014 12:00'},
      {x: 38, y: 248,time: 'January 15, 2014 12:00'},
      {x: 38, y: 214,time: 'January 16, 2014 12:00'},
      {x: 38, y: 202,time: 'January 17, 2014 12:00'},
      {x: 38, y: 194,time: 'January 18, 2014 12:00'},
      {x: 40, y: 194,time: 'January 19, 2014 12:00'},
      {x: 60, y: 194,time: 'January 20, 2014 12:00'},
      {x: 69, y: 194,time: 'January 21, 2014 12:00'},
      {x: 78, y: 194,time: 'January 22, 2014 12:00'},
      {x: 95, y: 195,time: 'January 23, 2014 12:00'},
      {x: 102, y: 195, time: 'January 24, 2014 12:00'},
      {x: 109, y: 195, time: 'January 25, 2014 12:00'},
      {x: 117, y: 195, time: 'January 26, 2014 12:00'},
      {x: 126, y: 195, time: 'January 27, 2014 12:00'},
      {x: 131, y: 194, time: 'January 28, 2014 12:00'},
      {x: 134, y: 192, time: 'January 29, 2014 12:00'},
      {x: 137, y: 192, time: 'January 30, 2014 12:00'},
      {x: 142, y: 192, time: 'January 31, 2014 12:00'},
      {x: 145, y: 192, time: 'February 1, 2014 12:00'},
      {x: 148, y: 192, time: 'February 2, 2014 12:00'},
      {x: 154, y: 192, time: 'February 3, 2014 12:00'},
      {x: 168, y: 192, time: 'February 4, 2014 12:00'},
      {x: 172, y: 192, time: 'February 5, 2014 12:00'},
      {x: 179, y: 192, time: 'February 6, 2014 12:00'},
      {x: 191, y: 191, time: 'February 7, 2014 12:00'},
      {x: 202, y: 190, time: 'February 8, 2014 12:00'},
      {x: 214, y: 190, time: 'February 9, 2014 12:00'},
      {x: 235, y: 189, time: 'February 10, 2014 12:00'},
      {x: 257, y: 188, time: 'February 11, 2014 12:00'},
      {x: 284, y: 186, time: 'February 12, 2014 12:00'},
      {x: 308, y: 182, time: 'February 13, 2014 12:00'},
      {x: 323, y: 179, time: 'February 14, 2014 12:00'},
      {x: 331, y: 177, time: 'February 15, 2014 12:00'},
      {x: 331, y: 175, time: 'February 16, 2014 12:00'},
      {x: 333, y: 175, time: 'February 17, 2014 12:00'},
      {x: 345, y: 175, time: 'February 18, 2014 12:00'},
      {x: 351, y: 176, time: 'February 19, 2014 12:00'},
      {x: 359, y: 176, time: 'February 20, 2014 12:00'},
      {x: 365, y: 176, time: 'February 21, 2014 12:00'},
      {x: 370, y: 176, time: 'February 22, 2014 12:00'},
      {x: 374, y: 176, time: 'February 23, 2014 12:00'},
      {x: 383, y: 176, time: 'February 24, 2014 12:00'},
      {x: 390, y: 176, time: 'February 25, 2014 12:00'},
      {x: 399, y: 173, time: 'February 26, 2014 12:00'},
      {x: 402, y: 171, time: 'February 27, 2014 12:00'},
      {x: 403, y: 171, time: 'February 28, 2014 12:00'},
      {x: 404, y: 171, time: 'March 1, 2014 12:00'},
      {x: 405, y: 171, time: 'March 2, 2014 12:00'},
      {x: 406, y: 170, time: 'March 3, 2014 12:00'},
      {x: 407, y: 169, time: 'March 4, 2014 12:00'},
      {x: 410, y: 169, time: 'March 5, 2014 12:00'},
      {x: 413, y: 168, time: 'March 6, 2014 12:00'},
      {x: 416, y: 166, time: 'March 7, 2014 12:00'},
      {x: 418, y: 165, time: 'March 8, 2014 12:00'},
      {x: 420, y: 164, time: 'March 9, 2014 12:00'},
      {x: 420, y: 162, time: 'March 10, 2014 12:00'},
      {x: 420, y: 161, time: 'March 11, 2014 12:00'},
      {x: 420, y: 160, time: 'March 12, 2014 12:00'},
      {x: 420, y: 160, time: 'March 13, 2014 12:00'},
      {x: 420, y: 158, time: 'March 14, 2014 12:00'},
      {x: 416, y: 156, time: 'March 15, 2014 12:00'},
      {x: 413, y: 155, time: 'March 16, 2014 12:00'},
      {x: 410, y: 155, time: 'March 17, 2014 12:00'},
      {x: 409, y: 154, time: 'March 18, 2014 12:00'},
      {x: 406, y: 154, time: 'March 19, 2014 12:00'},
      {x: 401, y: 154, time: 'March 20, 2014 12:00'},
      {x: 394, y: 153, time: 'March 21, 2014 12:00'},
      {x: 379, y: 153, time: 'March 22, 2014 12:00'},
      {x: 369, y: 153, time: 'March 23, 2014 12:00'},
      {x: 353, y: 157, time: 'March 24, 2014 12:00'},
      {x: 345, y: 161, time: 'March 25, 2014 12:00'},
      {x: 335, y: 168, time: 'March 26, 2014 12:00'},
      {x: 333, y: 169, time: 'March 27, 2014 12:00'},
      {x: 327, y: 175, time: 'March 28, 2014 12:00'},
      {x: 325, y: 177, time: 'March 29, 2014 12:00'},
      {x: 320, y: 184, time: 'March 30, 2014 12:00'},
      {x: 317, y: 189, time: 'March 31, 2014 12:00'},
      {x: 315, y: 194, time: 'April 1, 2014 12:00'},
      {x: 314, y: 197, time: 'April 2, 2014 12:00'},
      {x: 313, y: 200, time: 'April 3, 2014 12:00'},
      {x: 312, y: 203, time: 'April 4, 2014 12:00'},
      {x: 312, y: 207, time: 'April 5, 2014 12:00'},
      {x: 312, y: 213, time: 'April 6, 2014 12:00'},
      {x: 312, y: 217, time: 'April 7, 2014 12:00'},
      {x: 312, y: 219, time: 'April 8, 2014 12:00'},
      {x: 313, y: 226, time: 'April 9, 2014 12:00'},
      {x: 314, y: 229, time: 'April 10, 2014 12:00'},
      {x: 315, y: 230, time: 'April 11, 2014 12:00'},
      {x: 318, y: 232, time: 'April 12, 2014 12:00'},
      {x: 321, y: 237, time: 'April 13, 2014 12:00'},
      {x: 325, y: 241, time: 'April 14, 2014 12:00'},
      {x: 333, y: 247, time: 'April 15, 2014 12:00'},
      {x: 343, y: 253, time: 'April 16, 2014 12:00'},
      {x: 356, y: 260, time: 'April 17, 2014 12:00'},
      {x: 369, y: 263, time: 'April 18, 2014 12:00'},
      {x: 377, y: 264, time: 'April 19, 2014 12:00'},
      {x: 385, y: 265, time: 'April 20, 2014 12:00'},
      {x: 393, y: 268, time: 'April 21, 2014 12:00'},
      {x: 416, y: 268, time: 'April 22, 2014 12:00'},
      {x: 432, y: 268, time: 'April 23, 2014 12:00'},
      {x: 445, y: 268, time: 'April 24, 2014 12:00'},
      {x: 457, y: 266, time: 'April 25, 2014 12:00'},
      {x: 473, y: 260, time: 'April 26, 2014 12:00'},
      {x: 484, y: 255, time: 'April 27, 2014 12:00'},
      {x: 495, y: 252, time: 'April 28, 2014 12:00'},
      {x: 506, y: 247, time: 'April 29, 2014 12:00'},
      {x: 514, y: 245, time: 'April 30, 2014 12:00'},
      {x: 519, y: 243, time: 'May 1, 2014 12:00'},
      {x: 522, y: 241, time: 'May 2, 2014 12:00'},
      {x: 526, y: 238, time: 'May 3, 2014 12:00'},
      {x: 528, y: 237, time: 'May 4, 2014 12:00'},
      {x: 531, y: 235, time: 'May 5, 2014 12:00'},
      {x: 534, y: 232, time: 'May 6, 2014 12:00'},
      {x: 538, y: 230, time: 'May 7, 2014 12:00'},
      {x: 539, y: 217, time: 'May 8, 2014 12:00'},
      {x: 537, y: 217, time: 'May 9, 2014 12:00'},
      {x: 535, y: 217, time: 'May 10, 2014 12:00'},
      {x: 533, y: 217, time: 'May 11, 2014 12:00'},
      {x: 527, y: 217, time: 'May 12, 2014 12:00'},
      {x: 524, y: 218, time: 'May 13, 2014 12:00'},
      {x: 522, y: 220, time: 'May 14, 2014 12:00'},
      {x: 519, y: 221, time: 'May 15, 2014 12:00'},
      {x: 517, y: 224, time: 'May 16, 2014 12:00'},
      {x: 515, y: 226, time: 'May 17, 2014 12:00'},
      {x: 514, y: 227, time: 'May 18, 2014 12:00'},
      {x: 513, y: 230, time: 'May 19, 2014 12:00'},
      {x: 510, y: 234, time: 'May 20, 2014 12:00'},
      {x: 510, y: 235, time: 'May 21, 2014 12:00'},
      {x: 507, y: 237, time: 'May 22, 2014 12:00'},
      {x: 506, y: 239, time: 'May 23, 2014 12:00'},
      {x: 503, y: 243, time: 'May 24, 2014 12:00'},
      {x: 499, y: 246, time: 'May 25, 2014 12:00'},
      {x: 495, y: 249, time: 'May 26, 2014 12:00'},
      {x: 491, y: 252, time: 'May 27, 2014 12:00'},
      {x: 484, y: 255, time: 'May 28, 2014 12:00'},
      {x: 478, y: 260, time: 'May 29, 2014 12:00'},
      {x: 471, y: 262, time: 'May 30, 2014 12:00'},
      {x: 464, y: 264, time: 'May 31, 2014 12:00'},
      {x: 456, y: 266, time: 'June 1, 2014 12:00'},
      {x: 444, y: 266, time: 'June 2, 2014 12:00'},
      {x: 434, y: 268, time: 'June 3, 2014 12:00'},
      {x: 429, y: 269, time: 'June 4, 2014 12:00'},
      {x: 416, y: 274, time: 'June 5, 2014 12:00'},
      {x: 409, y: 276, time: 'June 6, 2014 12:00'},
      {x: 403, y: 279, time: 'June 7, 2014 12:00'},
      {x: 395, y: 282, time: 'June 8, 2014 12:00'},
      {x: 387, y: 285, time: 'June 9, 2014 12:00'},
      {x: 380, y: 287, time: 'June 10, 2014 12:00'},
      {x: 367, y: 289, time: 'June 11, 2014 12:00'},
      {x: 359, y: 290, time: 'June 12, 2014 12:00'},
      {x: 350, y: 292, time: 'June 13, 2014 12:00'},
      {x: 340, y: 294, time: 'June 14, 2014 12:00'},
      {x: 334, y: 296, time: 'June 15, 2014 12:00'},
      {x: 328, y: 300, time: 'June 16, 2014 12:00'},
      {x: 323, y: 305, time: 'June 17, 2014 12:00'},
      {x: 319, y: 310, time: 'June 18, 2014 12:00'},
      {x: 315, y: 315, time: 'June 19, 2014 12:00'},
      {x: 312, y: 318, time: 'June 20, 2014 12:00'},
      {x: 309, y: 320, time: 'June 21, 2014 12:00'},
      {x: 304, y: 324, time: 'June 22, 2014 12:00'},
      {x: 299, y: 327, time: 'June 23, 2014 12:00'},
      {x: 294, y: 329, time: 'June 24, 2014 12:00'},
      {x: 288, y: 331, time: 'June 25, 2014 12:00'},
      {x: 283, y: 335, time: 'June 26, 2014 12:00'},
      {x: 276, y: 338, time: 'June 27, 2014 12:00'},
      {x: 269, y: 340, time: 'June 28, 2014 12:00'},
      {x: 256, y: 346, time: 'June 29, 2014 12:00'},
      {x: 247, y: 349, time: 'June 30, 2014 12:00'},
      {x: 244, y: 350, time: 'July 1, 2014 12:00'},
      {x: 238, y: 352, time: 'July 2, 2014 12:00'},
      {x: 234, y: 352, time: 'July 3, 2014 12:00'},
      {x: 227, y: 354, time: 'July 4, 2014 12:00'},
      {x: 222, y: 357, time: 'July 5, 2014 12:00'},
      {x: 218, y: 358, time: 'July 6, 2014 12:00'},
      {x: 212, y: 358, time: 'July 7, 2014 12:00'},
      {x: 209, y: 360, time: 'July 8, 2014 12:00'},
      {x: 205, y: 360, time: 'July 9, 2014 12:00'},
      {x: 202, y: 360, time: 'July 10, 2014 12:00'},
      {x: 200, y: 360, time: 'July 11, 2014 12:00'},
      {x: 198, y: 360, time: 'July 12, 2014 12:00'},
      {x: 196, y: 358, time: 'July 13, 2014 12:00'},
      {x: 195, y: 356, time: 'July 14, 2014 12:00'},
      {x: 194, y: 353, time: 'July 15, 2014 12:00'},
      {x: 194, y: 349, time: 'July 16, 2014 12:00'},
      {x: 193, y: 346, time: 'July 17, 2014 12:00'},
      {x: 193, y: 345, time: 'July 18, 2014 12:00'},
      {x: 193, y: 344, time: 'July 19, 2014 12:00'},
      {x: 193, y: 342, time: 'July 20, 2014 12:00'},
      {x: 193, y: 341, time: 'July 21, 2014 12:00'},
      {x: 195, y: 341, time: 'July 22, 2014 12:00'},
      {x: 197, y: 340, time: 'July 23, 2014 12:00'},
      {x: 199, y: 339, time: 'July 24, 2014 12:00'},
      {x: 201, y: 338, time: 'July 25, 2014 12:00'},
      {x: 204, y: 338, time: 'July 26, 2014 12:00'},
      {x: 208, y: 338, time: 'July 27, 2014 12:00'},
      {x: 210, y: 338, time: 'July 28, 2014 12:00'},
      {x: 212, y: 338, time: 'July 29, 2014 12:00'},
      {x: 214, y: 338, time: 'July 30, 2014 12:00'},
      {x: 215, y: 338, time: 'July 31, 2014 12:00'},
      {x: 217, y: 338, time: 'August 1, 2014 12:00'},
      {x: 221, y: 338, time: 'August 2, 2014 12:00'},
      {x: 224, y: 338, time: 'August 3, 2014 12:00'},
      {x: 226, y: 337, time: 'August 4, 2014 12:00'},
      {x: 227, y: 337, time: 'August 5, 2014 12:00'},
      {x: 230, y: 336, time: 'August 6, 2014 12:00'},
      {x: 234, y: 336, time: 'August 7, 2014 12:00'},
      {x: 239, y: 309, time: 'August 8, 2014 12:00'},
      {x: 243, y: 307, time: 'August 9, 2014 12:00'},
      {x: 245, y: 307, time: 'August 10, 2014 12:00'},
      {x: 246, y: 321, time: 'August 11, 2014 12:00'},
      {x: 245, y: 346, time: 'August 12, 2014 12:00'}
    ]
    var paintIntensity = 1/300;
    var canvas = document.getElementById("heatmap-area");
    var heatmap = createWebGLHeatmap({canvas: canvas, intensityToAlpha:true});
    //document.body.appendChild(heatmap.canvas);

    /* BOOTSTRAP SLIDER */
    $('.slider').slider().on('slide', function(e) {
        //console.log(e.value);
        heatmap.clear();
        paintAtCoords(data.slice(e.value[0],e.value[1]));
    });

    //console.log($('.slider').slider('getValue'));

    var paintAtCoord = function(x, y){
        var count = 0;
        while(count < 100){
            var xoff = Math.random()*2-1;
            var yoff = Math.random()*2-1;
            var l = xoff*xoff + yoff*yoff;
            if(l > 1){
                continue;
            }
            var ls = Math.sqrt(l);
            xoff/=ls; yoff/=ls;
            xoff*=1-l; yoff*=1-l;
            count += 1;
            heatmap.addPoint(x+xoff*50, y+yoff*50, 30, paintIntensity);
        }
        //heatmap.addPoint(x, y, 60, 1/15);
    }

    var paintAtCoords = function(list) {
      var end = list.length;
      for (var i = 0; i < end; i++) {
        paintAtCoord(list[i]["x"], list[i]["y"]);
      }
    }

    // event handling
    var onTouchMove = function(evt){
        evt.preventDefault();
        var touches = evt.changedTouches;
        for(var i=0; i<touches.length; i++){
            var touch = touches[i];
            paintAtCoord(touch.pageX, touch.pageY);
        }
    };
    canvas.addEventListener("touchmove", onTouchMove, false);

    canvas.onmousemove = function(event){
        var x = event.offsetX || event.clientX;
        var y = event.offsetY || event.clientY;
        console.log("{x: " + x + ", y: " + y + ", size: 30, intensity: 1/3}");

        paintAtCoord(x, y);
            
    }

    var raf = window.requestAnimationFrame || window.mozRequestAnimationFrame ||
                             window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;

    var update = function(){
        //heatmap.addPoint(100, 100, 100, 10/255);
        heatmap.adjustSize(); // can be commented out for statically sized heatmaps, resize clears the map
        heatmap.update(); // adds the buffered points
        heatmap.display(); // adds the buffered points
        //heatmap.multiply(0.9995);
        //heatmap.blur();
        //heatmap.clamp(0.0, 1.0); // depending on usecase you might want to clamp it
        raf(update);
    }
    raf(update);

    // This function will replay a set of datapoints on the heatmap, putting a new point up every 50 ms.
    var play = function(list, start, end) {
      console.log("data.length = " + end);
      var i = start;
      var intervalID = setInterval(function(){
        //heatmap.addPoint(list[i]["x"], list[i]["y"], list[i]["size"], list[i]["intensity"]/2);
        heatmap.clear();
        //heatmap.addPoints(list.slice(0, i));
        //paintAtCoord(list[i]["x"], list[i]["y"]);
        paintAtCoords(list.slice(0,i));
        i++;
        if (i >= end)
          window.clearInterval(intervalID);
      }, 50);
      console.log("finished!");
    }

    //play(data, 0,data.length);

    paintAtCoords(data);
    

}
</script>

{% endblock %}
